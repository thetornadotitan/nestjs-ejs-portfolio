<%
  const hs = hostedServices || { public: [], private: [], generatedAt: null };
  const pub = hs.public || [];
  const priv = hs.private || [];

  function dotClass(health) {
    if (health === 'up') return 'bg-emerald-500';
    if (health === 'degraded') return 'bg-amber-500';
    if (health === 'down') return 'bg-rose-500';
    return 'bg-slate-400';
  }
%>

<div
  class="rounded-2xl border border-[var(--border)] bg-[var(--surface)] p-5 shadow-sm"
>
  <div class="flex items-center justify-between gap-3">
    <h2 class="font-medium">Hosted Services</h2>

    <span
      class="inline-flex items-center gap-2 rounded-xl border border-[var(--border)] bg-[var(--surface-2)] px-2.5 py-1 text-xs font-medium text-[var(--muted)]"
      title="Live snapshot"
    >
      <span
        class="inline-block h-2 w-2 rounded-full bg-emerald-500"
        aria-hidden="true"
      ></span>
      <span>
        Updated:
        <% if (hs.generatedAt) { %>
        <%= new Intl.DateTimeFormat('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              hour12: false
            }).format(new Date(hs.generatedAt)) %>
        <% } %>
      </span>
    </span>
  </div>

  <!-- Tooltip shell (anchored popup) -->
  <div
    id="hosted-services-tooltip"
    class="z-50 max-w-sm rounded-2xl border border-[var(--border)] bg-[var(--surface)] p-4 shadow-lg"
    aria-hidden="true"
  ></div>

  <!-- Public -->
  <div class="mt-4">
    <div class="text-xs sm:text-sm font-medium text-[var(--muted)]">Public</div>

    <% if (!pub.length) { %>
    <p class="mt-2 text-sm text-[var(--muted)]">No public services found.</p>
    <% } else { %>
    <div class="mt-2 flex flex-wrap gap-2">
      <% pub.forEach((svc) => { %>
      <button
        type="button"
        class="hs-chip inline-flex items-center gap-2 rounded-2xl border border-[var(--border)] bg-[var(--surface-2)] px-4 py-3 text-sm font-medium text-[var(--text)] shadow-sm active:scale-[0.99]"
        style="min-height: 44px"
        aria-label="<%= svc.name %> service details"
      >
        <span class="truncate max-w-[14rem] sm:max-w-[18rem]"
          ><%= svc.name %></span
        >
        <span
          class="inline-block h-2.5 w-2.5 rounded-full <%= dotClass(svc.health) %>"
          aria-hidden="true"
        ></span>

        <script type="application/json" class="hs-data">
          <%- JSON.stringify(svc) %>
        </script>
      </button>
      <% }) %>
    </div>
    <% } %>
  </div>

  <!-- Private -->
  <div class="mt-5">
    <div class="text-xs sm:text-sm font-medium text-[var(--muted)]">
      Private
    </div>

    <% if (!priv.length) { %>
    <p class="mt-2 text-sm text-[var(--muted)]">No private services found.</p>
    <% } else { %>
    <div class="mt-2 flex flex-wrap gap-2">
      <% priv.forEach((svc) => { %>
      <button
        type="button"
        class="hs-chip inline-flex items-center gap-2 rounded-2xl border border-[var(--border)] bg-[var(--surface-2)] px-4 py-3 text-sm font-medium text-[var(--text)] shadow-sm active:scale-[0.99]"
        style="min-height: 44px"
        aria-label="<%= svc.name %> service details"
      >
        <span class="truncate max-w-[14rem] sm:max-w-[18rem]"
          ><%= svc.name %></span
        >
        <span
          class="inline-block h-2.5 w-2.5 rounded-full <%= dotClass(svc.health) %>"
          aria-hidden="true"
        ></span>

        <script type="application/json" class="hs-data">
          <%- JSON.stringify(svc) %>
        </script>
      </button>
      <% }) %>
    </div>
    <% } %>

    <p class="mt-3 text-xs text-[var(--muted)]">
      Private services are accessible only from my internal network or VPN.
    </p>
  </div>
</div>
